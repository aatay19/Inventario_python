{% extends "base.html" %}
{% block title %}Crear Producto{% endblock %}
{% block content %}

<div class="card">
    <div class="card-header">
        <h4>Crear Un Nuevo Producto</h4>
    </div>
 
    <div class="card-body">
        <h4 class="card-title">Leer Código de Barras</h4>
        <div class="row">
            <div class="col-md-6">
                <h5>Opción 1: Subir archivo de imagen</h5>
                <input type="file" id="upload-file" class="form-control" accept="image/*">
            </div>
            <div class="col-md-6">
                <h5>Opción 2: Usar la cámara</h5>
                <button id="start-camera" class="btn btn-secondary">Iniciar Cámara</button>
                <div id="video-container" style="display: none; margin-top: 15px;">
                    <video id="video" width="320" height="240" autoplay style="border: 1px solid black;"></video>
                    <button id="scan-button" class="btn btn-info mt-2">Escanear Ahora</button>
                </div>
            </div>
        </div>
 
        <div id="resultado" class="mt-3 fw-bold"></div>

        <hr>

        <h4 class="card-title mt-4">Datos del Producto</h4>
        {%include 'inventario/form.html'%}
    </div>
</div>
 
{% endblock %}
 
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // El campo de código de producto que queremos rellenar. Django lo genera como 'id_codigo_producto'.
        const productCodeInput = document.getElementById('id_codigo_producto');
        const resultadoDiv = document.getElementById('resultado');
        const uploadFileInput = document.getElementById('upload-file');
        const startCameraButton = document.getElementById('start-camera');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('video');
        const scanButton = document.getElementById('scan-button');
 
        // --- Lógica para Opción 1: Subir Archivo ---
        uploadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                enviarImagenAlServidor(file);
            }
        });
 
        // --- Lógica para Opción 2: Usar Cámara ---
        startCameraButton.addEventListener('click', async () => {
            videoContainer.style.display = 'block';
            try {
                // Pedimos la cámara trasera ('environment') que es mejor para escanear
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
            } catch (err) {
                resultadoDiv.textContent = 'Error al acceder a la cámara: ' + err;
                resultadoDiv.className = 'alert alert-danger';
            }
        });
 
        scanButton.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
 
            // Convertir el canvas a un archivo (Blob) para enviarlo
            canvas.toBlob((blob) => {
                enviarImagenAlServidor(blob, 'scan.png');
            }, 'image/png');
        });
 
        // --- Función común para enviar la imagen al backend ---
        async function enviarImagenAlServidor(imageFile, fileName = 'image.png') {
            const formData = new FormData();
            formData.append('imagen', imageFile, fileName);
 
            resultadoDiv.textContent = 'Procesando...';
            resultadoDiv.className = 'alert alert-info';
 
            try {
                const response = await fetch("{% url 'decodificar_codigo' %}", {
                    method: 'POST',
                    body: formData,
                });
 
                const data = await response.json();
 
                if (response.ok && data.success) {
                    productCodeInput.value = data.codigo; // ¡Pone el código en el campo del formulario!
                    resultadoDiv.textContent = `Código encontrado (${data.tipo}): ${data.codigo}`;
                    resultadoDiv.className = 'alert alert-success';
                } else {
                    resultadoDiv.textContent = `Error: ${data.error}`;
                    resultadoDiv.className = 'alert alert-danger';
                }
            } catch (error) {
                resultadoDiv.textContent = 'Error de red al contactar el servidor.';
                resultadoDiv.className = 'alert alert-danger';
                console.error('Error en fetch:', error);
            }
        }
    });
</script>
{% endblock %}
